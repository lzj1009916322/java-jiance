<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.weservice.catering.wtakeout.modules.app.dao.ReportDao">

    <resultMap type="com.weservice.catering.wtakeout.modules.app.entity.OrderInfoEntity" id="orderInfoListMap">
        <result property="orderId" column="order_id"/>
        <result property="userId" column="user_id"/>
        <result property="productId" column="product_id"/>
        <!--        <result property="effective" column="effective"/>-->
        <result property="status" column="status"/>
        <result property="state" column="state"/>
        <result property="productName" column="product_name"/>
        <result property="productPicUrl" column="product_pic_url"/>
        <result property="takeoutOrder" column="takeout_order"/>
        <result property="productType" column="product_type"/>
        <result property="returnPoint" column="return_point"/>
        <result property="cost" column="cost"/>
        <result property="failReason" column="fail_reason"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <collection property="buyPics" ofType="com.weservice.catering.wtakeout.modules.app.entity.PicInfoEntity">
            <id property="picId" column="pic_id" jdbcType="INTEGER"/>
            <result property="picUrl" column="pic_url" jdbcType="VARCHAR"/>
            <result property="bizId" column="biz_id" jdbcType="VARCHAR"/>
            <result property="type" column="type" jdbcType="VARCHAR"/>
        </collection>
        <collection property="praisePics" ofType="com.weservice.catering.wtakeout.modules.app.entity.PicInfoEntity">
            <id property="picId" column="praise_pic_id" jdbcType="INTEGER"/>
            <result property="picUrl" column="prase_pic_url" jdbcType="VARCHAR"/>
            <result property="bizId" column="prase_biz_id" jdbcType="VARCHAR"/>
            <result property="type" column="praise_type" jdbcType="VARCHAR"/>
        </collection>
    </resultMap>


    <select id="getOrderList" resultMap="orderInfoListMap">
        select a.*,
        praise.pic_id as praise_pic_id,
        praise.pic_url as prase_pic_url,
        praise.biz_id as prase_biz_id,
        praise.type as praise_type
        FROM  (SELECT order_info.* from order_info
        where
        order_info.status = #{status}
        and
        order_info.update_time <![CDATA[ >=  ]]> #{startTime}
        and
        order_info.update_time <![CDATA[ <=  ]]> #{endTime}
<!--        <if test="productId!= null and productId!='' ">-->
            and order_info.product_id =#{productId}
<!--        </if>-->
         ) as  a
        LEFT JOIN pic_info praise
        ON  a.order_id :: TEXT = praise.biz_id and praise.type='praise'
<!--        <if test="productId!= null and productId!='' ">-->
<!--            and product_id =#{productId}-->
<!--        </if>-->
    </select>
    <select id="getMerchBillStatistics"
            resultType="com.weservice.catering.wtakeout.modules.app.entity.MerchBillStatisticsEntity">
        select product_id,
               product_name,
               sum(cost)         as sumCost,
               sum(return_point) as sumReturnPoint,
               sum(product_name) as sum
        from order_info
        where status = #{req.status}

          and update_time <![CDATA[ >=  ]]> #{req.startTime}

          and update_time <![CDATA[ <=  ]]> #{req.endTime}
        GROUP BY (product_id, product_name)
    </select>
</mapper>